<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Academics — OPAXI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared/styles.css?v=2025-09-16c">

  <style>
    .wrap{max-width:960px;margin:16px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px}
    .badge{background:#eef2ff;color:#1e3a8a}
    .hint{color:#64748b}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5f9}
    .chip.exam{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .chip.class{background:#e0f2fe;color:#075985;border:1px solid #bae6fd}
    .datebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .datebar input[type="date"]{width:auto}
  </style>
</head>
<body class="app-dark">
  <div id="header"></div>

  <div class="wrap">
    <!-- Top card -->
    <div class="card">
      <h2>Academics</h2>
      <p id="routineDesc" class="small" style="color:#64748b">Loading routine…</p>
      <div class="row">
        <a id="openRoutine" class="btn" href="#" target="_blank" rel="noopener" style="display:none">Open Routine</a>
        <a id="openResources" class="btn light" href="/resources.html">Open Resources</a>
      </div>

      <!-- Legend -->
      <div class="legend">
        <span class="small hint">Legend:</span>
        <span class="chip class">Class</span>
        <span class="chip exam">Exam/Assessment/Event</span>
      </div>
    </div>

    <!-- Profile -->
    <div class="card" id="profileCard">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div class="row" style="align-items:center;gap:10px;margin-bottom:10px">
              <span class="badge" id="profileRole">—</span>
              <span class="small">Term: <strong id="profileTerm">—</strong></span>
          </div>
          <button id="toggleProfile" class="btn light">Expand</button>
        </div>
  
        <div id="profileContent" style="display:none;">
            <label>Section</label>
            <select id="profileSection">
              <option value="">Select…</option>
            </select>
  
            <div id="subjectChecklist" style="margin-top:12px"></div>
  
            <div class="row" style="margin-top:12px">
              <button id="btnSaveProfile" class="btn">Save settings</button>
              <span id="profileMsg" class="msg"></span>
            </div>
  
            <div id="profileHelp" class="sticky" style="margin-top:12px">Select and save your Section above to see your classes.</div>
        </div>
      </div>

    <!-- Exams and Events block -->
    <section id="allExamsWrap"></section>

    <!-- Date picker -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;gap:12px">
        <div class="small" style="color:#475569;font-weight:600">Pick a date</div>
        <div class="datebar">
          <input type="date" id="pickDate" />
          <button class="iconbtn calendar" id="btnPickDate" aria-label="Open date picker" title="Pick a date">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V2zm13 8H4v10h16V10z"/>
            </svg>
          </button>
          <button id="btnGoDate" class="btn light">Show</button>
        </div>
      </div>
      <div id="selectedWrap" style="margin-top:8px"></div>
    </div>

    <!-- Schedule -->
    <div id="scheduleWrap"></div>

    <!-- Attendance -->
    <div class="card" id="attnView">
      <div class="small hint">Loading attendance…</div>
    </div>
  </div>

  <script type="module">
    import { renderHeader } from "/shared/ui.js";
    import { attachAuthHandlers } from "/shared/auth.js";
    import { auth } from "/shared/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { AcademicsController } from "/modules/academics/AcademicsController.js";

    onAuthStateChanged(auth, async (u) => {
      const email = u?.email || "";

      document.getElementById("header").innerHTML = renderHeader({
        title: "OPAXI",
        email,
        showAdmin: true,
        showCrisp: true,
        showAcadcom: true,
        seasonText: "Season: SIP",
        showHomeInSeason: true
      });
      attachAuthHandlers();

      // Main controller
      (new AcademicsController()).init();

      // Load attendance and both lock systems
      const bust = String(Date.now());
      const tasks = [
        import(`/modules/academics/components/AttendancePanel.js?v=${bust}`)
          .then((m) => new m.AttendancePanel().init("attnView"))
          .catch((e) => {
            console.warn("AttendancePanel not available (skipping):", e);
            const mount = document.getElementById("attnView");
            if (mount) mount.style.display = "none";
          }),
        import(`/modules/academics/SeniorProfileLock.js?v=${bust}`)
          .then((m) => m.wireSeniorProfileLock())
          .catch((e) => console.warn("SeniorProfileLock skipped:", e)),
        // ✅ NEW: Junior lock flow (2-change limit)
        import(`/modules/academics/JuniorProfileLock.js?v=${bust}`)
          .then((m) => m.wireJuniorProfileLock())
          .catch((e) => console.warn("JuniorProfileLock skipped:", e))
      ];

      try { await Promise.all(tasks); } catch (_) {}
    });

    const toggleButton = document.getElementById('toggleProfile');
    const profileContent = document.getElementById('profileContent');

    toggleButton.addEventListener('click', () => {
    if (profileContent.style.display === 'none') {
        profileContent.style.display = 'block';
        toggleButton.textContent = 'Collapse';
    } else {
        profileContent.style.display = 'none';
        toggleButton.textContent = 'Expand';
    }
    });
  </script>
</body>
</html>