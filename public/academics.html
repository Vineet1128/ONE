<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Academics — OPAXI</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared/styles.css?v=2025-09-16c">

  <style>
    .wrap{max-width:960px;margin:16px auto;padding:0 16px}

    .hint{color:var(--muted,#94a3b8)}

    /* Chips */
    .legend{display:flex;gap:10px;align-items:center;margin-top:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line,rgba(148,163,184,.35))}
    .chip.exam{background:rgba(248,113,113,.14);color:#fecaca;border-color:rgba(248,113,113,.25)}
    .chip.class{background:rgba(56,189,248,.14);color:#bae6fd;border-color:rgba(56,189,248,.25)}
    .chip.sub{background:rgba(163,230,53,.16);color:#d9f99d;border-color:rgba(163,230,53,.26)}

    /* ✅ Force legend in one line everywhere on this page */
    .legend.one-line{
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
    }
    .legend.one-line::-webkit-scrollbar{ height:6px; }
    .legend.one-line::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.14); border-radius:999px; }
    .legend.one-line::-webkit-scrollbar-track{ background:rgba(255,255,255,.06); border-radius:999px; }

    /* ONE-green button (used only for CTAs) */
    .btn.one{
      background:rgba(163,230,53,.92);
      color:#0b1220;
      border:1px solid rgba(163,230,53,.55);
      box-shadow:0 10px 24px rgba(163,230,53,.10);
      text-decoration:none; /* safety for <a> */
    }
    .btn.one:hover{filter:brightness(1.03)}
    .btn.one:active{transform:translateY(1px)}

    /* Date picker row */
    .datebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .datebar input[type="date"]{width:auto}

    /* Profile modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:80}
    .modal{width:min(720px,92vw);max-height:86vh;overflow:auto;background:var(--card,#0b1220);border:1px solid var(--line,rgba(148,163,184,.35));border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    .modal .modal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid var(--line,rgba(148,163,184,.35))}
    .modal .modal-body{padding:16px}
    .modal .xbtn{background:transparent;border:0;font-size:18px;cursor:pointer;line-height:1;padding:6px 10px;border-radius:10px;color:inherit}
    .modal .xbtn:hover{background:rgba(148,163,184,.18)}
  </style>
</head>

<body class="app-dark">
  <div id="header"></div>

  <div class="wrap">
    <!-- Top card -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px">
        <div>
          <h2 style="margin-bottom:6px">Academics</h2>
          <p id="routineDesc" class="small hint">Loading routine…</p>
        </div>

        <!-- ✅ My Profile back to normal (not green) -->
        <button id="btnMyProfile" class="btn light" type="button">My Profile</button>
      </div>

      <div class="row" style="flex-wrap:wrap;gap:10px">
        <!-- Compatibility: kept hidden -->
        <a id="openRoutine" class="btn" href="#" target="_blank" rel="noopener"
           style="display:none !important; pointer-events:none !important; opacity:0 !important;"
           aria-hidden="true" tabindex="-1">Open Routine</a>

        <!-- ✅ Green CTAs -->
        <a id="openResources" class="btn one" href="/resources.html">Open Resources</a>
        <a id="openPlan" class="btn one" href="/plan.html">Plan</a>
      </div>

      <!-- ✅ Legend one-line -->
      <div class="legend one-line" aria-label="Legend">
        <span class="small hint">Legend:</span>
        <span class="chip class">Class</span>
        <span class="chip exam">Exam</span>
        <span class="chip sub">Submissions</span>
      </div>
    </div>

    <!-- Exams -->
    <section id="allExamsWrap"></section>

    <!-- Pick a date: You said it should be moved to Plan, so this stays removed if you already removed it -->
    <!-- <div class="card">...</div> -->

    <!-- Schedule -->
    <div id="scheduleWrap"></div>

    <!-- Attendance -->
    <div class="card" id="attnView">
      <div class="small hint">Loading attendance…</div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-backdrop" id="profileModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
      <div class="modal-head">
        <div class="row" style="align-items:center;gap:10px;flex-wrap:wrap">
          <strong id="profileModalTitle">My Profile</strong>
          <span class="badge" id="profileRole">—</span>
          <span class="small">Term: <strong id="profileTerm">—</strong></span>
        </div>
        <button class="xbtn" id="btnCloseProfile" type="button" aria-label="Close">✕</button>
      </div>

      <div class="modal-body">
        <div id="profileContent" style="display:block;">
          <label>Section</label>
          <select id="profileSection">
            <option value="">Select…</option>
          </select>

          <div id="subjectChecklist" style="margin-top:12px"></div>

          <div class="row" style="margin-top:12px;align-items:center;gap:10px;flex-wrap:wrap">
            <button id="btnSaveProfile" class="btn one" type="button">Save settings</button>
            <span id="profileMsg" class="msg"></span>
            <span id="changeRemain" class="small hint" style="margin-left:auto"></span>
          </div>

          <div id="profileHelp" class="sticky" style="margin-top:12px">
            Select and save your Section above to see your classes.
          </div>

          <button id="toggleProfile" class="btn light" type="button" style="display:none">Expand</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { renderHeader } from "/shared/ui.js";
    import { attachAuthHandlers } from "/shared/auth.js";
    import { auth } from "/shared/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { AcademicsController } from "/modules/academics/AcademicsController.js";

    const backdrop = document.getElementById("profileModalBackdrop");
    const btnMyProfile = document.getElementById("btnMyProfile");
    const btnClose = document.getElementById("btnCloseProfile");

    const openProfile = () => {
      if (!backdrop) return;
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
    };
    const closeProfile = () => {
      if (!backdrop) return;
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
    };

    btnMyProfile?.addEventListener("click", openProfile);
    btnClose?.addEventListener("click", closeProfile);
    backdrop?.addEventListener("click", (e) => { if (e.target === backdrop) closeProfile(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeProfile(); });

    onAuthStateChanged(auth, async (u) => {
      const email = u?.email || "";

      document.getElementById("header").innerHTML = renderHeader({
        title: "OPAXI",
        email,
        showAdmin: true,
        showCrisp: true,
        showAcadcom: true,
        seasonText: "Season: SIP",
        showHomeInSeason: true
      });
      attachAuthHandlers();

      (new AcademicsController()).init();

      const bust = String(Date.now());
      const tasks = [
        import(`/modules/academics/components/AttendancePanel.js?v=${bust}`)
          .then((m) => new m.AttendancePanel().init("attnView"))
          .catch((e) => {
            console.warn("AttendancePanel not available (skipping):", e);
            const mount = document.getElementById("attnView");
            if (mount) mount.style.display = "none";
          }),
        import(`/modules/academics/SeniorProfileLock.js?v=${bust}`)
          .then((m) => m.wireSeniorProfileLock())
          .catch((e) => console.warn("SeniorProfileLock skipped:", e)),
        import(`/modules/academics/JuniorProfileLock.js?v=${bust}`)
          .then((m) => m.wireJuniorProfileLock())
          .catch((e) => console.warn("JuniorProfileLock skipped:", e))
      ];

      try { await Promise.all(tasks); } catch (_) {}
    });

    const toggleButton = document.getElementById('toggleProfile');
    const profileContent = document.getElementById('profileContent');
    toggleButton?.addEventListener('click', () => {
      if (!profileContent) return;
      if (profileContent.style.display === 'none') {
        profileContent.style.display = 'block';
        toggleButton.textContent = 'Collapse';
      } else {
        profileContent.style.display = 'none';
        toggleButton.textContent = 'Expand';
      }
    });

    const openRoutine = document.getElementById("openRoutine");
    if (openRoutine) {
      openRoutine.style.display = "none";
      openRoutine.setAttribute("aria-hidden", "true");
      openRoutine.tabIndex = -1;
    }
  </script>
</body>
</html>