<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ONE — Home</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#101828">

  <!-- iOS PWA support -->
  <link rel="apple-touch-icon" href="/assets/brand/one/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared/styles.css"/>

  <style>
    :root{
      --bg:#101828;
      --panel:#0b1223;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:rgba(148,163,184,.18);

      --one-green:#B0D030;
      --one-blue:#0050A0;

      --ring:rgba(176,208,48,.28);
      --ok:#22c55e;
      --danger:#ef4444;
    }

    html,body{height:100%}
    body{
      margin:0;
      min-height:100dvh;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    .backdrop{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1000px 560px at 8% 0%, rgba(0,80,160,.22), transparent 60%),
        radial-gradient(1000px 620px at 100% 100%, rgba(176,208,48,.12), transparent 60%);
      filter:saturate(112%);
    }

    #header{ position:sticky; top:0; z-index:30; }

    /* season ribbon container already styled in shared/styles.css via .seasonbar */
    #seasonTopBar{ display:none; }

    .home-wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .welcome{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:16px 16px 14px;
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:0 10px 30px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .welcomeTop{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--ok);
      box-shadow:0 0 0 4px rgba(34,197,94,.14);
      flex:0 0 auto;
    }
    .welcomeTitle{
      font-size:22px;
      font-weight:800;
      letter-spacing:.2px;
      line-height:1.15;
    }

    .welcomeSub{
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:2px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0b1223;
      color:#fff;
      font-weight:700;
      text-decoration:none;
      cursor:pointer;
      transition:transform .04s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
      min-height:46px;
    }
    .btn:hover{ border-color:var(--ring); box-shadow:0 12px 28px rgba(0,0,0,.22); }
    .btn:active{ transform:translateY(1px); }

    .chip{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:#e5e7eb;
      font-weight:700;
      min-height:40px;
    }
    .chip:hover{
      border-color:rgba(176,208,48,.28);
      box-shadow:none;
    }

    .btn.primary{
      background:var(--one-green);
      color:#0b1223;
      border:1px solid rgba(255,255,255,.08);
    }

    .cta-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width:720px){
      .cta-grid{ grid-template-columns:1fr 1fr; }
    }

    .cta-card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .cta-head{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cta-card h3{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .cta-card p{
      margin:0;
      color:var(--muted);
      line-height:1.35;
    }
    .cta-actions{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }

    .small{ font-size:13px; color:var(--muted); }

    .note-stub{
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      color:var(--muted);
    }
    .note-stub strong{ color:#e5e7eb; }

    .btn.is-disabled{
      opacity:.5;
      pointer-events:none;
      cursor:not-allowed;
      filter:grayscale(35%);
    }

    /* stronger header logo */
    .topbar .brand img{ height:34px; }
    .topbar__center img{ height:34px !important; }

    @media (max-width:520px){
      .home-wrap{ padding:14px; }
      .welcomeTitle{ font-size:20px; }
      .topbar .brand img{ height:32px; }
      .topbar__center img{ height:32px !important; }
    }
  </style>
</head>

<body class="app-dark">
  <div class="backdrop"></div>

  <div id="header"></div>

  <!-- Season ribbon (we keep this, but now it has proper structure + About ONE on right) -->
  <div id="seasonTopBar" class="seasonbar">
    <div class="seasonbar__left" id="seasonText"></div>
    <div class="seasonbar__right">
      <a class="pill about-pill" href="/about.html" aria-label="About ONE">About ONE</a>
    </div>
  </div>

  <div class="home-wrap">
    <div class="welcome">
      <div class="welcomeTop">
        <span class="dot" aria-hidden="true"></span>
        <div id="welcome" class="welcomeTitle">Welcome</div>
      </div>

      <div class="welcomeSub">Your workspace — choose a module.</div>

      <div class="pill-row">
        <button id="btnAdminView"   class="btn chip" style="display:none">Admin</button>
        <button id="btnCrispView"   class="btn chip" style="display:none">CRISP</button>
        <button id="btnAcadcomView" class="btn chip" style="display:none">Acadcom</button>
        <button id="btnAlcomView"   class="btn chip" style="display:none">Alcom</button>
      </div>
    </div>

    <div class="cta-grid">
      <div class="cta-card" id="cardAcademics">
        <div class="cta-head">
          <h3>Academics</h3>
          <p>Routine, subjects, and attendance.</p>
        </div>
        <div class="cta-actions">
          <a id="btnAcademics" class="btn primary" href="/academics.html">Go to Academics</a>
        </div>
        <div id="acadHint" class="small"></div>
      </div>

      <div class="cta-card" id="cardPreparation">
        <div class="cta-head">
          <h3>Preparation</h3>
          <p>Mentoring sessions, slots, and bookings.</p>
        </div>
        <div class="cta-actions">
          <a id="btnPreparation" class="btn primary" href="#">Open Preparation</a>
        </div>
        <div id="prepHint" class="small"></div>
      </div>
    </div>

    <div class="note-stub">
      <strong>Notifications</strong><br>
      <span id="notification-status" class="small">You’ll see booking updates and reminders here.</span>
    </div>
  </div>

  <script type="module">
    import { attachAuthHandlers } from "/shared/auth.js";
    import { auth, db, doc, getDoc, setDoc, onSnapshot, arrayUnion } from "/shared/firebase.js?v=1.3";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { renderHeader, initHeaderLogoFallback } from "/shared/ui.js";

    const VAPID_PUBLIC_KEY = "BPpJyJX0nHDwJeb1_MfEitAebbQBPtK58SisZAlzxKblgjPIfq9Slzzm2SvJTlxsl7ofq6iEs5H3p6yYowhQscU";
    const isSeniorEmail = (e)=> /^b24.*@astra.xlri.ac.in$/i.test(e||"");
    const isJuniorEmail = (e)=> /^b25.*@astra.xlri.ac.in$/i.test(e||"");

    const $ = (id)=> document.getElementById(id);

    function firstNameFrom(user){
      const dn = user?.displayName || "";
      if (dn) return dn.split(" ")[0];
      const email = user?.email || "";
      return email ? email.split("@")[0] : "there";
    }

    function emailHandle(email){
      return (email || "").split("@")[0] || "";
    }

    let __prepDisabled = false;
    let __acadDisabled = false;

    function setPrepLink({ email, reverse }) {
      const btn  = $("btnPreparation");
      const hint = $("prepHint");
      if (!btn || __prepDisabled) return;

      const senior = isSeniorEmail(email);
      const junior = isJuniorEmail(email);
      let href = senior ? "/senior.html" : (junior ? "/junior.html" : "#");
      let msg  = senior ? "You are recognized as Senior (b24*)."
                        : (junior ? "You are recognized as Junior (b25*)."
                                  : "Your cohort could not be inferred from email.");
      if (reverse) {
        href = senior ? "/junior.html" : (junior ? "/senior.html" : "#");
        if (senior) msg = "Roles reversed: Senior accessing Junior prep.";
        else if (junior) msg = "Roles reversed: Junior providing Senior-style prep.";
      }
      if (href === "#") btn.removeAttribute("href"); else btn.href = href;
      if (hint) hint.textContent = msg;
    }

    function setSeasonBar({ seasonName, reverse }) {
      const bar = $("seasonTopBar");
      const textEl = $("seasonText");
      if (!bar || !textEl) return;

      if (!reverse && !seasonName) {
        bar.style.display = "none";
        textEl.textContent = "";
        bar.classList.remove("reverse");
        return;
      }

      const parts = [];
      if (seasonName) parts.push(`Season: ${seasonName}`);
      if (reverse) parts.push("Roles reversed");
      textEl.textContent = parts.join(" — ");

      bar.classList.toggle("reverse", !!reverse);
      bar.style.display = "grid";
    }

    function applyHomeButtonFlags({ showAcademics=true, showPreparation=true }){
      const btnA = $("btnAcademics"), acadHint = $("acadHint");
      __acadDisabled = !showAcademics;
      if (btnA){
        btnA.classList.toggle("is-disabled", !showAcademics);
        btnA.setAttribute("aria-disabled", !showAcademics);
        if(showAcademics) btnA.href = "/academics.html"; else btnA.removeAttribute("href");
        if(acadHint) acadHint.textContent = showAcademics ? "" : "Coming soon!";
      }

      const btnP = $("btnPreparation"), prepHint = $("prepHint");
      __prepDisabled = !showPreparation;
      if (btnP){
        btnP.classList.toggle("is-disabled", !showPreparation);
        btnP.setAttribute("aria-disabled", !showPreparation);
        if(prepHint) prepHint.textContent = showPreparation ? "" : "Coming soon!";
      }
    }

    async function getRolesByEmail(email){
      const exact = (email || "").trim(), lower = exact.toLowerCase();
      try{
        const s1 = await getDoc(doc(db, "roles", lower)); if (s1.exists()) return s1.data() || {};
        const s2 = await getDoc(doc(db, "roles", exact)); if (s2.exists()) return s2.data() || {};
      } catch(e){ console.warn("Roles lookup failed:", e); }
      return {};
    }

    function setNotificationStatus(message) {
      const el = $('notification-status');
      if (el) el.textContent = message;
    }
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function subscribeToPushNotifications(user) {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        setNotificationStatus("Push notifications not supported.");
        return;
      }
      try {
        const registration = await navigator.serviceWorker.ready;
        let subscription = await registration.pushManager.getSubscription();
        if (subscription) { setNotificationStatus("You are subscribed to notifications."); return; }

        const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
        subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
        setNotificationStatus("Successfully subscribed to notifications!");

        const userDocRef = doc(db, "users", user.uid);
        await setDoc(userDocRef, { pushSubscriptions: arrayUnion(JSON.parse(JSON.stringify(subscription))) }, { merge: true });
      } catch (error) {
        console.error("Push subscription failed:", error);
        if (Notification.permission === 'denied') setNotificationStatus("Notifications blocked. Please enable in browser settings.");
        else setNotificationStatus("Could not subscribe to notifications.");
      }
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => {
          console.error('SW registration failed: ', err);
          setNotificationStatus("Failed to set up notifications.");
        });
      });
    }

    onAuthStateChanged(auth, async (u)=>{
      if (!u) return;
      const email = u.email || "";

      $("header").innerHTML = renderHeader();
      initHeaderLogoFallback(document);
      attachAuthHandlers();

      const name = firstNameFrom(u), handle = emailHandle(email);
      $("welcome").textContent = handle ? `Welcome, ${name} (${handle})` : `Welcome, ${name}`;

      subscribeToPushNotifications(u);

      const roles = await getRolesByEmail(email);
      const isAdmin = !!roles.admin || !!roles.isAdmin || (email === "b24408@astra.xlri.ac.in");
      const isCrisp = !!roles.isCrisp;
      const isAcadcom = !!roles.acadcom;
      const isAlcom = !!roles.alcom;

      if ($("btnAdminView")) { $("btnAdminView").style.display = isAdmin ? "inline-flex" : "none"; if(isAdmin) $("btnAdminView").onclick = ()=> window.location.href = "/admin.html"; }
      if ($("btnCrispView")) { $("btnCrispView").style.display = isCrisp ? "inline-flex" : "none"; if(isCrisp) $("btnCrispView").onclick = ()=> window.location.href = "/crisp.html"; }
      if ($("btnAcadcomView")) { $("btnAcadcomView").style.display = isAcadcom ? "inline-flex" : "none"; if(isAcadcom) $("btnAcadcomView").onclick = ()=> window.location.href = "/acadcom.html"; }
      if ($("btnAlcomView")) { $("btnAlcomView").style.display = isAlcom ? "inline-flex" : "none"; if(isAlcom) $("btnAlcomView").onclick = ()=> window.location.href = "/alcom.html"; }

      setPrepLink({ email, reverse:false });
      let lastFlags = { showAcademics:true, showPreparation:true };

      try {
        const ref = doc(db, "settings", "app");
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data()||{}) : {};
        const reverse = !!d.reverseRoles;
        const seasonName = d.seasonName || "";
        setSeasonBar({ seasonName, reverse });
        lastFlags = { showAcademics: d.homeShowAcademics !== false, showPreparation: d.homeShowPreparation !== false };
        applyHomeButtonFlags(lastFlags);
        setPrepLink({ email, reverse });

        onSnapshot(ref, (s)=>{
          const dd = s.exists() ? (s.data()||{}) : {};
          const rev = !!dd.reverseRoles;
          setSeasonBar({ seasonName:(dd.seasonName||""), reverse:rev });
          const flags = { showAcademics: dd.homeShowAcademics !== false, showPreparation: dd.homeShowPreparation !== false };
          if (flags.showAcademics !== lastFlags.showAcademics || flags.showPreparation !== lastFlags.showPreparation){
            lastFlags = flags;
            applyHomeButtonFlags(flags);
          }
          setPrepLink({ email, reverse:rev });
        });
      } catch (e) {
        console.warn("Settings read failed; using defaults.", e);
        setSeasonBar({ seasonName:"", reverse:false });
        applyHomeButtonFlags(lastFlags);
        setPrepLink({ email, reverse:false });
      }

      try {
        const mod = await import("/modules/home/AttendanceWidget.js");
        new mod.AttendanceWidget().init();
      } catch (e) { console.warn("Attendance widget not loaded:", e); }
    });
  </script>
</body>
</html>