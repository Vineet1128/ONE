<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ONE — Home</title>

  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/assets/common/logo.png">
  <meta name="theme-color" content="#0f172a">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared/styles.css"/>

  <style>
    :root{
      --bg:#0f172a; --panel:#0b1223; --text:#e5e7eb; --muted:#94a3b8;
      --ring:rgba(59,130,246,.35); --accent:#3b82f6; --accent2:#22d3ee;
      --border:rgba(148,163,184,.18); --ok:#22c55e;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .backdrop{ position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1100px 520px at -10% -10%, rgba(34,211,238,.16), transparent 55%),
        radial-gradient(900px 600px at 120% 120%, rgba(59,130,246,.20), transparent 55%);
      filter:saturate(115%);
    }

    #header{ position:sticky; top:0; z-index:30; }

    .seasonbar{
      display:none; padding:10px 16px; font-size:13px; color:#dbeafe;
      background:linear-gradient(90deg, rgba(59,130,246,.18), rgba(34,211,238,.18));
      border-bottom:1px solid var(--border);
    }
    .seasonbar.reverse{ background:linear-gradient(90deg, rgba(34,211,238,.18), rgba(59,130,246,.18)); }

    .home-wrap{ max-width:940px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:14px; }
    .welcome{ font-size:22px; font-weight:700; letter-spacing:.2px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .welcome::before{ content:""; width:10px; height:10px; border-radius:999px; background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.15); }
    .pill-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 16px; border-radius:14px; border:1px solid var(--border);
      background:#0b1223; color:#fff; font-weight:600; text-decoration:none; cursor:pointer;
      transition:transform .04s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:hover{ border-color:var(--ring); box-shadow:0 10px 26px rgba(2,132,199,.22); }
    .btn:active{ transform:translateY(1px); }
    .btn.light{ background:#0b1223; color:#e6edf6; border:1px solid var(--border); }
    .cta-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:720px){ .cta-grid{ grid-template-columns:1fr 1fr; } }
    .cta-card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:18px; padding:16px;
      box-shadow:0 8px 26px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .cta-card h3{ margin:0 0 6px; font-size:18px; }
    .cta-card p{ margin:0 0 12px; color:var(--muted); }
    .cta-card .btn{ width:auto; padding:10px 14px; border-radius:12px; }
    .note-stub{ margin-top:6px; padding:14px 16px; border:1px solid var(--border);
      border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); color:var(--muted);
    }
    .small{ font-size:13px; color:var(--muted); }

    .btn.is-disabled{
      opacity:.5;
      pointer-events:none;
      cursor:not-allowed;
      filter:grayscale(35%);
    }
  </style>
</head>

<body>
  <div class="backdrop"></div>

  <div id="header"></div>
  <div id="seasonTopBar" class="seasonbar"></div>

  <div class="home-wrap">
    <div id="welcome" class="welcome">Welcome</div>

    <div class="pill-row">
      <button id="btnAdminView"   class="btn light" style="display:none">Admin</button>
      <button id="btnCrispView"   class="btn light" style="display:none">CRISP</button>
      <button id="btnAcadcomView" class="btn light" style="display:none">Acadcom</button>
      <button id="btnAlcomView"   class="btn light" style="display:none">Alcom</button>
    </div>

    <div class="cta-grid">
      <div class="cta-card" id="cardAcademics">
        <h3>Academics</h3>
        <p>Routine, subjects, and attendance.</p>
        <a id="btnAcademics" class="btn" href="/academics.html">Go to Academics</a>
        <div id="acadHint" class="small" style="margin-top:6px"></div>
      </div>

      <div class="cta-card" id="cardPreparation">
        <h3>Preparation</h3>
        <p>Mentoring sessions, slots, and bookings.</p>
        <a id="btnPreparation" class="btn" href="#">Open Preparation</a>
        <div id="prepHint" class="small" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="note-stub">
      <strong>Notifications</strong><br>
      <span id="notification-status" class="small">You’ll see booking updates and reminders here.</span>
    </div>
  </div>

  <script type="module">
    import { attachAuthHandlers } from "/shared/auth.js";
    import { auth, db, doc, getDoc, setDoc, onSnapshot, arrayUnion } from "/shared/firebase.js?v=1.3";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { renderHeader } from "/shared/ui.js";

    const VAPID_PUBLIC_KEY = "BPpJyJX0nHDwJeb1_MfEitAebbQBPtK58SisZAlzxKblgjPIfq9Slzzm2SvJTlxsl7ofq6iEs5H3p6yYowhQscU";
    const isSeniorEmail = (e)=> /^b24.*@astra.xlri.ac.in$/i.test(e||"");
    const isJuniorEmail = (e)=> /^b25.*@astra.xlri.ac.in$/i.test(e||"");

    const $ = (id)=> document.getElementById(id);

    function firstNameFrom(user){
      const dn = user?.displayName || "";
      if (dn) return dn.split(" ")[0];
      const email = user?.email || "";
      return email ? email.split("@")[0] : "there";
    }

    function emailHandle(email){
      return (email || "").split("@")[0] || "";
    }

    let __prepDisabled = false;
    let __acadDisabled = false;

    function setPrepLink({ email, reverse }) {
      const btn  = $("btnPreparation");
      const hint = $("prepHint");
      if (!btn || __prepDisabled) return;

      const senior = isSeniorEmail(email);
      const junior = isJuniorEmail(email);
      let href = senior ? "/senior.html" : (junior ? "/junior.html" : "#");
      let msg  = senior ? "You are recognized as Senior (b24*)."
                        : (junior ? "You are recognized as Junior (b25*)."
                                  : "Your cohort could not be inferred from email.");
      if (reverse) {
        href = senior ? "/junior.html" : (junior ? "/senior.html" : "#");
        if (senior) msg = "Roles reversed: Senior accessing Junior prep.";
        else if (junior) msg = "Roles reversed: Junior providing Senior-style prep.";
      }
      if (href === "#") btn.removeAttribute("href"); else btn.href = href;
      if (hint) hint.textContent = msg;
    }

    function setSeasonBar({ seasonName, reverse }) {
      const bar = $("seasonTopBar");
      if (!bar) return;
      if (!reverse && !seasonName) { bar.style.display = "none"; bar.textContent=""; bar.classList.remove("reverse"); return; }
      const parts = [];
      if (seasonName) parts.push(`Season: ${seasonName}`);
      if (reverse) parts.push("Roles reversed");
      bar.textContent = parts.join(" — ");
      bar.classList.toggle("reverse", !!reverse);
      bar.style.display = "block";
    }

    function applyHomeButtonFlags({ showAcademics=true, showPreparation=true }){
      const btnA = $("btnAcademics"), acadHint = $("acadHint");
      __acadDisabled = !showAcademics;
      if (btnA){
        btnA.classList.toggle("is-disabled", !showAcademics);
        btnA.setAttribute("aria-disabled", !showAcademics);
        if(showAcademics) btnA.href = "/academics.html"; else btnA.removeAttribute("href");
        if(acadHint) acadHint.textContent = showAcademics ? "" : "Coming soon!";
      }

      const btnP = $("btnPreparation"), prepHint = $("prepHint");
      __prepDisabled = !showPreparation;
      if (btnP){
        btnP.classList.toggle("is-disabled", !showPreparation);
        btnP.setAttribute("aria-disabled", !showPreparation);
        if(prepHint) prepHint.textContent = showPreparation ? "" : "Coming soon!";
      }
    }

    async function getRolesByEmail(email){
      const exact = (email || "").trim(), lower = exact.toLowerCase();
      try{
        const s1 = await getDoc(doc(db, "roles", lower)); if (s1.exists()) return s1.data() || {};
        const s2 = await getDoc(doc(db, "roles", exact)); if (s2.exists()) return s2.data() || {};
      } catch(e){ console.warn("Roles lookup failed:", e); }
      return {};
    }

    // ---------- Push Notifications ----------
    function setNotificationStatus(message) {
        const el = $('notification-status');
        if (el) el.textContent = message;
    }
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
    }

    async function subscribeToPushNotifications(user) {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            setNotificationStatus("Push notifications not supported.");
            return;
        }
        try {
            const registration = await navigator.serviceWorker.ready;
            let subscription = await registration.pushManager.getSubscription();
            if (subscription) { setNotificationStatus("You are subscribed to notifications."); return; }

            const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
            subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey });
            setNotificationStatus("Successfully subscribed to notifications!");

            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, { pushSubscriptions: arrayUnion(JSON.parse(JSON.stringify(subscription))) }, { merge: true });
        } catch (error) {
            console.error("Push subscription failed:", error);
            if (Notification.permission === 'denied') setNotificationStatus("Notifications blocked. Please enable in browser settings.");
            else setNotificationStatus("Could not subscribe to notifications.");
        }
    }

    // ---------- Service Worker Registration ----------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => {
          console.error('SW registration failed: ', err);
          setNotificationStatus("Failed to set up notifications.");
        });
      });
    }

    onAuthStateChanged(auth, async (u)=>{
      if (!u) return; // Should be handled by attachAuthHandlers, but as a guard
      const email = u.email || "";
      $("header").innerHTML = renderHeader();
      attachAuthHandlers();

      const name = firstNameFrom(u), handle = emailHandle(email);
      $("welcome").textContent = handle ? `Welcome, ${name} (${handle})` : `Welcome, ${name}`;
      
      // Attempt to subscribe to push notifications
      subscribeToPushNotifications(u);

      const roles = await getRolesByEmail(email);
      const isAdmin = !!roles.admin || !!roles.isAdmin || (email === "b24408@astra.xlri.ac.in");
      const isCrisp = !!roles.isCrisp;
      const isAcadcom = !!roles.acadcom;
      const isAlcom = !!roles.alcom;

      if ($("btnAdminView")) { $("btnAdminView").style.display = isAdmin ? "inline-flex" : "none"; if(isAdmin) $("btnAdminView").onclick = ()=> window.location.href = "/admin.html"; }
      if ($("btnCrispView")) { $("btnCrispView").style.display = isCrisp ? "inline-flex" : "none"; if(isCrisp) $("btnCrispView").onclick = ()=> window.location.href = "/crisp.html"; }
      if ($("btnAcadcomView")) { $("btnAcadcomView").style.display = isAcadcom ? "inline-flex" : "none"; if(isAcadcom) $("btnAcadcomView").onclick = ()=> window.location.href = "/acadcom.html"; }
      if ($("btnAlcomView")) { $("btnAlcomView").style.display = isAlcom ? "inline-flex" : "none"; if(isAlcom) $("btnAlcomView").onclick = ()=> window.location.href = "/alcom.html"; }

      setPrepLink({ email, reverse:false });
      let lastFlags = { showAcademics:true, showPreparation:true };

      try {
        const ref = doc(db, "settings", "app");
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data()||{}) : {};
        const reverse = !!d.reverseRoles;
        const seasonName = d.seasonName || "";
        setSeasonBar({ seasonName, reverse });
        lastFlags = { showAcademics: d.homeShowAcademics !== false, showPreparation: d.homeShowPreparation !== false };
        applyHomeButtonFlags(lastFlags);
        setPrepLink({ email, reverse });

        onSnapshot(ref, (s)=>{
          const dd = s.exists() ? (s.data()||{}) : {};
          const rev = !!dd.reverseRoles;
          setSeasonBar({ seasonName:(dd.seasonName||""), reverse:rev });
          const flags = { showAcademics: dd.homeShowAcademics !== false, showPreparation: dd.homeShowPreparation !== false };
          if (flags.showAcademics !== lastFlags.showAcademics || flags.showPreparation !== lastFlags.showPreparation){
            lastFlags = flags;
            applyHomeButtonFlags(flags);
          }
          setPrepLink({ email, reverse:rev });
        });
      } catch (e) {
        console.warn("Settings read failed; using defaults.", e);
        setSeasonBar({ seasonName:"", reverse:false });
        applyHomeButtonFlags(lastFlags);
        setPrepLink({ email, reverse:false });
      }

      try {
        const mod = await import("/modules/home/AttendanceWidget.js");
        new mod.AttendanceWidget().init();
      } catch (e) { console.warn("Attendance widget not loaded:", e); }
    });
  </script>
</body>
</html>