<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ONE</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared/styles.css"/>

  <style>
    :root{
      --bg:#0f172a; --panel:#0b1223; --text:#e5e7eb; --muted:#94a3b8;
      --ring:rgba(59,130,246,.35); --accent:#3b82f6; --accent2:#22d3ee;
      --border:rgba(148,163,184,.18); --ok:#22c55e; --bad:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .backdrop{ position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1100px 520px at -10% -10%, rgba(34,211,238,.16), transparent 55%),
        radial-gradient(900px 600px at 120% 120%, rgba(59,130,246,.20), transparent 55%);
      filter:saturate(115%);
    }
    .card{
      width:min(560px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:22px; padding:22px;
      box-shadow:0 12px 32px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .brand{ display:flex; flex-direction:column; align-items:center; gap:10px; text-align:center; }
    .brand img{ height:54px; width:auto; border-radius:12px; }
    .brand h1{ margin:0; font-size:34px; letter-spacing:.4px; }
    .brand p{ margin:0; font-size:13px; color:var(--muted); font-weight:600; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px; font-weight:700; }
    .divider{ height:1px; background:var(--border); margin:18px 0; }

    .form{ display:flex; flex-direction:column; gap:10px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; color:var(--muted); font-weight:700; }
    input{
      padding:12px 12px; border-radius:14px;
      border:1px solid var(--border); background:#0b1223; color:#fff; outline:none;
    }
    input:focus{ border-color:var(--ring); box-shadow:0 0 0 3px rgba(59,130,246,.18); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:14px; border:1px solid var(--border);
      background:#0b1223; color:#fff; font-weight:800; text-decoration:none; cursor:pointer;
      transition:transform .04s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:hover{ border-color:var(--ring); box-shadow:0 10px 26px rgba(2,132,199,.22); }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:linear-gradient(90deg, rgba(59,130,246,.95), rgba(34,211,238,.85)); border:none; }
    .btn.google{ background:#0b1223; border:1px solid var(--border); }
    .btn.ghost{ background:transparent; }

    .status{
      margin-top:12px; padding:12px 12px; border:1px solid var(--border); border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      color:var(--muted); font-size:13px; line-height:1.4;
    }
    .status.ok{ border-color: rgba(34,197,94,.30); }
    .status.bad{ border-color: rgba(239,68,68,.30); }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; color:#e2e8f0; }
    .small{ font-size:12px; color:var(--muted); }
    a{ color:#93c5fd; text-decoration:none; } a:hover{ text-decoration:underline; }
    .hide{ display:none !important; }
    .center{ text-align:center; }
  </style>
</head>

<body>
  <div class="backdrop"></div>

  <main class="card" aria-label="ONE entry">
    <div class="brand">
      <img src="/assets/common/logo.png" alt="ONE logo">
      <h1>ONE</h1>
      <p>Built by Students of XLRI</p>
    </div>

    <div class="divider"></div>

    <!-- MODE: IDENTITY (email only) -->
    <form id="formIdentity" class="form">
      <div class="field">
        <label for="idEmail">Email or Google account</label>
        <input id="idEmail" type="email" placeholder="you@astra.xlri.ac.in / you@xlri.ac.in / gmail.com" required>
      </div>
      <div class="row">
        <button id="btnContinue" class="btn primary" type="submit">Continue</button>
        <button id="btnGoogle" class="btn google" type="button">Continue with Google</button>
      </div>
      <div class="small center">
        Students usually use <span class="mono">@astra.xlri.ac.in</span>, Faculty use <span class="mono">@xlri.ac.in</span>, Alumni may use personal email.
      </div>
    </form>

    <!-- MODE: LOGIN (password) -->
    <form id="formLogin" class="form hide" autocomplete="on">
      <div class="field">
        <label>Email</label>
        <input id="loginEmail" type="email" readonly>
      </div>
      <div class="field">
        <label for="loginPass">Password</label>
        <input id="loginPass" type="password" placeholder="Your password" minlength="6" required>
      </div>
      <div class="row">
        <button id="btnDoLogin" class="btn primary" type="submit">Login</button>
        <button id="btnForgot" class="btn ghost" type="button">Forgot password?</button>
        <button id="btnResend" class="btn ghost hide" type="button">Resend verification email</button>
        <button id="btnSignOut" class="btn ghost hide" type="button">Sign out</button>
      </div>
    </form>

    <!-- MODE: SIGNUP -->
    <form id="formSignup" class="form hide" autocomplete="on">
      <div class="field">
        <label>Email</label>
        <input id="signupEmail" type="email" readonly>
      </div>
      <div class="field">
        <label for="signupPass">Create password</label>
        <input id="signupPass" type="password" placeholder="Minimum 6 characters" minlength="6" required>
      </div>
      <div class="row">
        <button id="btnDoSignup" class="btn primary" type="submit">Create account</button>
        <button id="btnBackIdentity" class="btn ghost" type="button">Back</button>
      </div>
      <div class="small">We’ll email you a verification link after signup.</div>
    </form>

    <div id="status" class="status">Checking session…</div>

    <div class="divider"></div>
    <div class="row">
        <button id="btnEnableNotifications" class="btn">Enable Notifications</button>
        <button id="btnSendTestNotification" class="btn">Send Test Notification</button>
    </div>
  </main>

  <script type="module">
    import { auth, db, doc, getDoc, setDoc, serverTimestamp } from "/shared/firebase.js";
    import {
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      fetchSignInMethodsForEmail,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      sendPasswordResetEmail,
      signOut,
      reload
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const $ = (id)=>document.getElementById(id);

    // ---------- UI refs ----------
    const formIdentity = $("formIdentity");
    const formLogin    = $("formLogin");
    const formSignup   = $("formSignup");

    const idEmail      = $("idEmail");
    const btnContinue  = $("btnContinue");
    const btnGoogle    = $("btnGoogle");

    const loginEmail   = $("loginEmail");
    const loginPass    = $("loginPass");
    const btnDoLogin   = $("btnDoLogin");
    const btnForgot    = $("btnForgot");
    const btnResend    = $("btnResend");
    const btnOut       = $("btnSignOut");

    const signupEmail  = $("signupEmail");
    const signupPass   = $("signupPass");
    const btnDoSignup  = $("btnDoSignup");
    const btnBackId    = $("btnBackIdentity");

    const statusEl     = $("status");
    
    const btnEnableNotifications = $("btnEnableNotifications");
    const btnSendTestNotification = $("btnSendTestNotification");

    // ---------- Constants ----------
    const ROLLOVER_MONTH = 3;   // March
    const ROLLOVER_DAY   = 15;  // 15th
    const PROGRAM_YEARS_DEFAULT = 2;
    const studentMatch = (email)=> /^b(\d{2}).*@astra\.xlri\.ac\.in$/i.exec(email||"");
    const lcEmail = (e)=> (e||"").toLowerCase();

    function show(el, on=true){ if(!el) return; el.classList.toggle("hide", !on); }
    function setStatus(msg, kind=""){ statusEl.classList.remove("ok","bad"); if(kind) statusEl.classList.add(kind); statusEl.innerHTML = msg; }
    function setMode(mode, emailValue=""){
      // modes: identity | login | signup
      show(formIdentity, mode==="identity");
      show(formLogin,    mode==="login");
      show(formSignup,   mode==="signup");
      if (mode==="login"){ loginEmail.value = emailValue; loginPass.value=""; setStatus("Enter your password to continue."); }
      if (mode==="signup"){ signupEmail.value = emailValue; signupPass.value=""; setStatus("Create your ONE account. We will send a verification link."); }
      if (mode==="identity"){ setStatus("Enter your email to continue."); }
    }

    // ---------- Friendly errors ----------
    function friendly(code){
      switch(code){
        case "auth/email-already-in-use": return "Account already exists. Please login instead.";
        case "auth/invalid-email": return "Please enter a valid email address.";
        case "auth/weak-password": return "Password is too weak (min 6 characters).";
        case "auth/user-not-found": return "No account found. Create one in the next step.";
        case "auth/wrong-password": return "Incorrect password. Try again or reset it.";
        case "auth/too-many-requests": return "Too many attempts. Please try again later.";
        case "auth/network-request-failed": return "Network error. Check your connection.";
        default: return null;
      }
    }

    // ---------- Roles + routing (your existing logic preserved) ----------
    async function getRolesByEmail(email){
      const ref1 = doc(db, "roles", lcEmail(email));
      const s1 = await getDoc(ref1); if (s1.exists()) return s1.data()||{};
      const ref2 = doc(db, "roles", email);
      const s2 = await getDoc(ref2); if (s2.exists()) return s2.data()||{};
      return {};
    }
    function computeStage({ startYear, programYears }){
      const now = new Date();
      const y = now.getFullYear();
      const rollover = new Date(y, ROLLOVER_MONTH-1, ROLLOVER_DAY);
      const academicYear = now < rollover ? (y - startYear + 1) : (y - startYear + 2);
      if (academicYear <= programYears){
        return { stage:"student", studentYear:Math.max(1,academicYear), alumniYear:0, label: academicYear===1?"Student Year 1":"Student Year 2" };
      }
      const alumniYear = academicYear - programYears;
      return { stage:"alumni", studentYear:0, alumniYear, label:`Alumni Y${alumniYear}` };
    }
    async function ensureUserDocForStudent(user){
      const m = studentMatch(user.email||""); if (!m) return false;
      const yy = parseInt(m[1],10); const startYear = 2000+yy; const programYears=PROGRAM_YEARS_DEFAULT; const endYear=startYear+programYears;
      const computed = computeStage({startYear, programYears});
      await setDoc(doc(db,"users",user.uid), {
        uid:user.uid, primaryEmail:user.email||"", emailVerified:true,
        persona:"student", status:"active",
        cohort:{ startYear, programYears, endYear, program:"BM/HRM", campus:"JSR/DEL" },
        computed, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      }, {merge:true});
      return true;
    }
    async function ensureUserDocForFacultyIfAllowlisted(user){
      const roles = await getRolesByEmail(user.email||""); if (roles?.faculty!==true) return false;
      await setDoc(doc(db,"users",user.uid), {
        uid:user.uid, primaryEmail:user.email||"", emailVerified:true,
        persona:"faculty", status:"active",
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      }, {merge:true});
      return true;
    }
    async function routeUser(user){
      const uref = doc(db,"users",user.uid); const usnap = await getDoc(uref);
      if (usnap.exists()){
        const d = usnap.data()||{};
        if (d.status==="active"){
          if (d.persona==="faculty") return window.location.replace("/faculty/home.html");
          if (d.persona==="student") return window.location.replace("/home.html");
          if (d.persona==="alumni")  return window.location.replace("/alumni/home.html");
          return window.location.replace("/home.html");
        }
        if (d.status==="pending") return window.location.replace("/pending.html");
      }
      // not onboarded → try auto paths
      if (await ensureUserDocForStudent(user)) return window.location.replace("/home.html");
      if (await ensureUserDocForFacultyIfAllowlisted(user)) return window.location.replace("/faculty/home.html");
      return window.location.replace("/onboarding.html"); // alumni / unknown
    }

    // ---------- Notifications ----------
    function requestNotificationPermission() {
      if (!("Notification" in window)) {
        setStatus("This browser does not support desktop notification", "bad");
        return;
      }
      Notification.requestPermission().then(function (permission) {
        if (permission === "granted") {
          setStatus("Notification permission granted.", "ok");
        } else {
          setStatus("Notification permission denied.", "bad");
        }
      });
    }

    function sendNotification(title, body) {
      if (Notification.permission === "granted") {
        new Notification(title, { body: body });
      } else {
        setStatus("You need to enable notifications first!", "bad");
      }
    }
    
    btnEnableNotifications.addEventListener("click", requestNotificationPermission);
    btnSendTestNotification.addEventListener("click", () => sendNotification('Hello!', 'This is a test notification from ONE.'));

    // ---------- Identity-first flow ----------
    setMode("identity");

    formIdentity.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = (idEmail.value||"").trim();
      if (!email) return;

      btnContinue.disabled = true; btnContinue.style.opacity="0.7";
      try{
        // Which methods exist for this email?
        const methods = await fetchSignInMethodsForEmail(auth, email);
        // If password is configured for this email → login
        if (methods.includes("password")){
          setMode("login", email);
          return;
        }
        // If Google is configured (but no password) → suggest Google
        if (methods.includes("google.com")){
          setStatus("This account uses Google Sign-In. Click the button above to continue.", "ok");
          setMode("identity");
          idEmail.value = email;
          return;
        }
        // No methods → go to signup with this email prefilled
        setMode("signup", email);
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Could not check account."), "bad");
      } finally{
        btnContinue.disabled = false; btnContinue.style.opacity="";
      }
    });

    // Google button is explicit (no popup until user clicks)
    btnGoogle.addEventListener("click", async ()=>{
      const provider = new GoogleAuthProvider();
      try{
        const cred = await signInWithPopup(auth, provider);
        await reload(cred.user);
        if (!cred.user.emailVerified){
          // Google accounts are already verified by provider; but guard anyway.
          setStatus(`Signed in with Google as <span class="mono">${cred.user.email}</span>.`, "ok");
        }
        setStatus(`Signed in as <span class="mono">${cred.user.email}</span>. Routing…`, "ok");
        await routeUser(cred.user);
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Google sign-in failed."), "bad");
      }
    });

    // ---------- Login ----------
    formLogin.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = (loginEmail.value||"").trim();
      const pass  = (loginPass.value||"");

      btnDoLogin.disabled = true; btnDoLogin.style.opacity="0.7";
      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await reload(cred.user);
        if (!cred.user.emailVerified){
          setStatus(`Email not verified for <span class="mono">${email}</span>.`, "bad");
          show(btnResend,true); show(btnOut,true);
          return;
        }
        setStatus(`Signed in as <span class="mono">${email}</span>. Routing…`, "ok");
        await routeUser(cred.user);
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Login failed."), "bad");
      } finally{
        btnDoLogin.disabled = false; btnDoLogin.style.opacity="";
      }
    });

    btnForgot.addEventListener("click", async ()=>{
      const email = (loginEmail.value||"").trim();
      if (!email){ setStatus("Enter your email above, then click ‘Forgot password?’", "bad"); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        setStatus(`Password reset email sent to <span class="mono">${email}</span>.`, "ok");
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Could not send reset email."), "bad");
      }
    });

    btnResend.addEventListener("click", async ()=>{
      const u = auth.currentUser; if (!u) return;
      try{ await sendEmailVerification(u); setStatus(`Verification email sent again to <span class="mono">${u.email}</span>.`, "ok"); }
      catch(err){ setStatus(`Could not resend verification email. ${err?.message||""}`, "bad"); }
    });

    btnOut.addEventListener("click", async ()=>{
      await signOut(auth); setMode("identity"); setStatus("Signed out.");
      show(btnResend,false); show(btnOut,false);
    });

    // ---------- Signup ----------
    formSignup.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = (signupEmail.value||"").trim();
      const pass  = (signupPass.value||"");

      btnDoSignup.disabled = true; btnDoSignup.style.opacity="0.7";
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await sendEmailVerification(cred.user);
        setStatus(`Account created for <span class="mono">${email}</span>. Verify your email, then return here to login.`, "ok");
        show(btnResend,true); show(btnOut,true);
        // Take user back to Login with email prefilled
        setMode("login", email);
      } catch(err){
        // If account already exists, push to login
        if (err?.code === "auth/email-already-in-use"){
          setMode("login", email);
          setStatus("Account already exists. Please login or reset your password.", "bad");
        } else {
          setStatus(friendly(err?.code) || (err?.message || "Signup failed."), "bad");
        }
      } finally{
        btnDoSignup.disabled = false; btnDoSignup.style.opacity="";
      }
    });

    btnBackId.addEventListener("click", ()=> setMode("identity"));

    // ---------- Session listener ----------
    onAuthStateChanged(auth, async (u)=>{
      if (!u){ setMode("identity"); show(btnResend,false); show(btnOut,false); setStatus("Enter your email to continue."); return; }
      show(btnOut,true);
      try{
        await reload(u);
        if (!u.emailVerified){
          setStatus(`Signed in as <span class="mono">${u.email}</span>. Please verify your email to continue.`, "bad");
          show(btnResend,true);
          return;
        }
        setStatus(`Signed in as <span class="mono">${u.email}</span>. Routing…`, "ok");
        await routeUser(u);
      } catch(err){
        setStatus(`Session check failed. ${err?.message || ""}`, "bad");
      }
    });
  </script>
</body>
</html>