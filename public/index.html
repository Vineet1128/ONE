<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ONE</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#101828">

  <!-- iOS PWA support -->
  <link rel="apple-touch-icon" href="/assets/brand/one/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared/styles.css"/>

  <style>
    :root{
      --bg:#101828;
      --panel:#0b1223;
      --text:#F8F8F8;
      --muted:#94a3b8;
      --border:rgba(148,163,184,.18);

      --one-green:#B0D030;
      --one-blue:#0050A0;

      --ring:rgba(176,208,48,.28);
    }

    html,body{height:100%}
    body{
      margin:0;
      min-height:100dvh;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    .bg{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(0,80,160,.22), transparent 60%),
        radial-gradient(900px 560px at 100% 100%, rgba(176,208,48,.12), transparent 60%);
      filter:saturate(112%);
    }

    .page{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
    }
    .xlri{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
    }
    .xlri img{
      height:28px;
      width:auto;
      display:block;
    }
    .topbar .spacer{
      width:44px;
      height:1px;
      opacity:0;
    }

    .hero{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px 0;
    }
    .heroInner{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      text-align:center;
    }
    .oneLogo{
      width:min(320px, 78vw);
      height:auto;
      display:block;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.30));
      object-fit:contain;
    }

    .sheet{
      width:100%;
      display:flex;
      justify-content:center;
      padding:0 16px 18px;
    }
    .sheetInner{
      width:min(560px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 18px 44px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.06);
      padding:18px;
    }

    .form{ display:flex; flex-direction:column; gap:10px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; color:var(--muted); font-weight:700; }

    input{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel);
      color:#fff;
      outline:none;
    }
    input:focus{
      border-color:rgba(176,208,48,.45);
      box-shadow:0 0 0 3px rgba(176,208,48,.16);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#111827;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      transition:transform .04s ease, box-shadow .15s ease, border-color .15s ease;
      min-height:46px;
      flex:1 1 160px;
    }
    .btn:hover{ border-color:var(--ring); box-shadow:0 12px 28px rgba(0,0,0,.22); }
    .btn:active{ transform:translateY(1px); }

    .btn.primary{
      background:var(--one-green);
      color:#0b1223;
      border:1px solid rgba(255,255,255,.08);
    }

    .btn.google{
      background:#0b1223;
      color:#fff;
      border:1px solid var(--border);
    }

    .btn.ghost{
      background:transparent;
      border:1px solid transparent;
      color:#cbd5e1;
      flex:0 0 auto;
      min-height:auto;
      padding:10px 10px;
    }

    .status{
      margin-top:10px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .status.ok{ border-color: rgba(176,208,48,.26); }
    .status.bad{ border-color: rgba(239,68,68,.30); }

    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; color:#e2e8f0; }
    .small{ font-size:12px; color:var(--muted); line-height:1.4; }
    .center{ text-align:center; }
    .hide{ display:none !important; }

    @media (max-width: 420px){
      .sheetInner{ padding:16px; border-radius:20px; }
      .oneLogo{ width:min(300px, 84vw); }
    }
  </style>
</head>

<body class="app-dark">
  <div class="bg"></div>

  <div class="page">
    <header class="topbar">
      <div class="xlri">
        <img src="/assets/brand/xlri/xlri-mark.png" alt="XLRI">
      </div>
      <div class="spacer"></div>
    </header>

    <section class="hero">
      <div class="heroInner">
        <!-- Logo with safe fallback chain (no behavior change) -->
        <img
          id="oneIndexLogo"
          class="oneLogo"
          src="/assets/brand/one/one-logo-dark.png"
          alt="ONE — Built by XLRI Students"
          loading="eager"
          decoding="async"
        >
      </div>
    </section>

    <section class="sheet">
      <main class="sheetInner" aria-label="ONE entry">

        <form id="formIdentity" class="form">
          <div class="field">
            <label for="idEmail">Email or Google account</label>
            <input id="idEmail" type="email" placeholder="you@astra.xlri.ac.in / you@xlri.ac.in / gmail.com" required>
          </div>

          <div class="row">
            <button id="btnContinue" class="btn primary" type="submit">Continue</button>
            <button id="btnGoogle" class="btn google" type="button">Continue with Google</button>
          </div>

          <div class="small center">
            Students usually use <span class="mono">@astra.xlri.ac.in</span>, Faculty use <span class="mono">@xlri.ac.in</span>, Alumni may use personal email.
          </div>
        </form>

        <form id="formLogin" class="form hide" autocomplete="on">
          <div class="field">
            <label>Email</label>
            <input id="loginEmail" type="email" readonly>
          </div>
          <div class="field">
            <label for="loginPass">Password</label>
            <input id="loginPass" type="password" placeholder="Your password" minlength="6" required>
          </div>
          <div class="row">
            <button id="btnDoLogin" class="btn primary" type="submit">Login</button>
            <button id="btnForgot" class="btn ghost" type="button">Forgot password?</button>
            <button id="btnResend" class="btn ghost hide" type="button">Resend verification email</button>
            <button id="btnSignOut" class="btn ghost hide" type="button">Sign out</button>
          </div>
        </form>

        <form id="formSignup" class="form hide" autocomplete="on">
          <div class="field">
            <label>Email</label>
            <input id="signupEmail" type="email" readonly>
          </div>
          <div class="field">
            <label for="signupPass">Create password</label>
            <input id="signupPass" type="password" placeholder="Minimum 6 characters" minlength="6" required>
          </div>
          <div class="row">
            <button id="btnDoSignup" class="btn primary" type="submit">Create account</button>
            <button id="btnBackIdentity" class="btn ghost" type="button">Back</button>
          </div>
          <div class="small">We’ll email you a verification link after signup.</div>
        </form>

        <div id="status" class="status">Checking session…</div>
      </main>
    </section>
  </div>

  <!-- JS BELOW IS UNCHANGED (except logo fallback helper at top) -->
  <script type="module">
    // --- Logo fallback (safe; no app logic change) ---
    (() => {
      const img = document.getElementById("oneIndexLogo");
      if (!img) return;
      const fallbacks = [
        "/assets/brand/one/one-logo-dark.png",
        "/assets/brand/one/one-lockup.png",
        "/assets/brand/one/one-mark-512.png",
        "/assets/brand/one/one-mark-192.png"
      ];
      let i = 0;
      img.addEventListener("error", () => {
        i += 1;
        if (i < fallbacks.length) img.src = fallbacks[i];
      });
    })();

    import { auth, db, doc, getDoc, setDoc, serverTimestamp, arrayUnion } from "/shared/firebase.js?v=1.8";
    import {
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      fetchSignInMethodsForEmail,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      sendPasswordResetEmail,
      signOut,
      reload
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const $ = (id)=>document.getElementById(id);

    const formIdentity = $("formIdentity");
    const formLogin    = $("formLogin");
    const formSignup   = $("formSignup");
    const idEmail      = $("idEmail");
    const btnContinue  = $("btnContinue");
    const btnGoogle    = $("btnGoogle");
    const loginEmail   = $("loginEmail");
    const loginPass    = $("loginPass");
    const btnDoLogin   = $("btnDoLogin");
    const btnForgot    = $("btnForgot");
    const btnResend    = $("btnResend");
    const btnOut       = $("btnSignOut");
    const signupEmail  = $("signupEmail");
    const signupPass   = $("signupPass");
    const btnDoSignup  = $("btnDoSignup");
    const btnBackId    = $("btnBackIdentity");
    const statusEl     = $("status");

    const VAPID_PUBLIC_KEY = "BPpJyJX0nHDwJeb1_MfEitAebbQBPtK58SisZAlzxKblgjPIfq9Slzzm2SvJTlxsl7ofq6iEs5H3p6yYowhQscU";

    const ROLLOVER_MONTH = 3;
    const ROLLOVER_DAY   = 15;
    const PROGRAM_YEARS_DEFAULT = 2;
    const studentMatch = (email)=> /^b(\d{2}).*@astra\.xlri\.ac\.in$/i.exec(email||"");
    const lcEmail = (e)=> (e||"").toLowerCase();

    function show(el, on=true){ if(!el) return; el.classList.toggle("hide", !on); }
    function setStatus(msg, kind=""){ statusEl.classList.remove("ok","bad"); if(kind) statusEl.classList.add(kind); statusEl.innerHTML = msg; }
    function setMode(mode, emailValue="") {
      show(formIdentity, mode==="identity");
      show(formLogin,    mode==="login");
      show(formSignup,   mode==="signup");
      if (mode === "login") {
        loginEmail.value = emailValue;
        loginPass.value = "";
        show(btnResend, false);
        show(btnOut, true);
        setStatus("Enter your password to continue.");
      }
      if (mode === "signup") {
        signupEmail.value = emailValue;
        signupPass.value = "";
        setStatus("Create your ONE account. We will send a verification link.");
      }
      if (mode === "identity") {
        idEmail.value = "";
        setStatus("Enter your email to continue.");
        show(btnOut, false);
      }
    }

    function friendly(code){
      switch(code){
        case "auth/email-already-in-use": return "Account already exists. Please login instead.";
        case "auth/invalid-email": return "Please enter a valid email address.";
        case "auth/weak-password": return "Password is too weak (min 6 characters).";
        case "auth/user-not-found": return "No account found. Create one in the next step.";
        case "auth/wrong-password": return "Incorrect password. Try again or reset it.";
        case "auth/too-many-requests": return "Too many attempts. Please try again later.";
        case "auth/network-request-failed": return "Network error. Check your connection.";
        default: return null;
      }
    }

    async function getRolesByEmail(email){
      const ref1 = doc(db, "roles", lcEmail(email));
      const s1 = await getDoc(ref1); if (s1.exists()) return s1.data()||{};
      const ref2 = doc(db, "roles", email);
      const s2 = await getDoc(ref2); if (s2.exists()) return s2.data()||{};
      return {};
    }
    function computeStage({ startYear, programYears }){
      const now = new Date();
      const y = now.getFullYear();
      const rollover = new Date(y, ROLLOVER_MONTH-1, ROLLOVER_DAY);
      const academicYear = now < rollover ? (y - startYear + 1) : (y - startYear + 2);
      if (academicYear <= programYears){
        return { stage:"student", studentYear:Math.max(1,academicYear), alumniYear:0, label: academicYear===1?"Student Year 1":"Student Year 2" };
      }
      const alumniYear = academicYear - programYears;
      return { stage:"alumni", studentYear:0, alumniYear, label:`Alumni Y${alumniYear}` };
    }
    async function ensureUserDocForStudent(user){
      const m = studentMatch(user.email||""); if (!m) return false;
      const yy = parseInt(m[1],10); const startYear = 2000+yy; const programYears=PROGRAM_YEARS_DEFAULT; const endYear=startYear+programYears;
      const computed = computeStage({startYear, programYears});
      await setDoc(doc(db,"users",user.uid), {
        uid:user.uid, primaryEmail:user.email||"", emailVerified:true,
        persona:"student", status:"active",
        cohort:{ startYear, programYears, endYear, program:"BM/HRM", campus:"JSR/DEL" },
        computed, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      }, {merge:true});
      return true;
    }
    async function ensureUserDocForFacultyIfAllowlisted(user){
      const roles = await getRolesByEmail(user.email||""); if (roles?.faculty!==true) return false;
      await setDoc(doc(db,"users",user.uid), {
        uid:user.uid, primaryEmail:user.email||"", emailVerified:true,
        persona:"faculty", status:"active",
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      }, {merge:true});
      return true;
    }
    async function routeUser(user){
      subscribeToPushNotifications(user);

      const uref = doc(db,"users",user.uid); const usnap = await getDoc(uref);
      if (usnap.exists()){
        const d = usnap.data()||{};
        if (d.status==="active"){
          if (d.persona==="faculty") return window.location.replace("/faculty/home.html");
          if (d.persona==="student") return window.location.replace("/home.html");
          if (d.persona==="alumni")  return window.location.replace("/alumni/home.html");
          return window.location.replace("/home.html");
        }
        if (d.status==="pending") return window.location.replace("/pending.html");
      }
      if (await ensureUserDocForStudent(user)) return window.location.replace("/home.html");
      if (await ensureUserDocForFacultyIfAllowlisted(user)) return window.location.replace("/faculty/home.html");
      return window.location.replace("/onboarding.html");
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function subscribeToPushNotifications(user) {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        console.warn("Push notifications not supported by this browser.");
        return;
      }
      try {
        const registration = await navigator.serviceWorker.ready;
        let subscription = await registration.pushManager.getSubscription();
        if (subscription) { return; }

        const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
        subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        });

        const userDocRef = doc(db, "users", user.uid);
        await setDoc(userDocRef, {
            pushSubscriptions: arrayUnion(JSON.parse(JSON.stringify(subscription)))
        }, { merge: true });

      } catch (error) {
        console.error("Failed to subscribe to push notifications:", error);
      }
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(error => {
            console.error('ServiceWorker registration failed: ', error);
          });
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await reload(user);
        if (user.emailVerified) {
          setStatus(`Signed in as <span class="mono">${user.email}</span>. Routing…`, "ok");
          show(btnOut, true);
          routeUser(user);
        } else {
          setMode("login", user.email);
          setStatus(`Email not verified for <span class="mono">${user.email}</span>.`, "bad");
          show(btnResend, true);
        }
      } else {
        setMode("identity");
      }
    });

    formIdentity.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = (idEmail.value||"").trim();
      if (!email) return;
      btnContinue.disabled = true; btnContinue.style.opacity="0.7";
      try{
        const methods = await fetchSignInMethodsForEmail(auth, email);
        if (methods.includes("password")){ setMode("login", email); return; }
        if (methods.includes("google.com")){
          setStatus("This account uses Google Sign-In. Click the button above to continue.", "ok");
          setMode("identity"); idEmail.value = email; return;
        }
        setMode("signup", email);
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Could not check account."), "bad");
      } finally{
        btnContinue.disabled = false; btnContinue.style.opacity="";
      }
    });

    btnGoogle.addEventListener("click", async ()=> {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Google sign-in failed."), "bad");
      }
    });

    formLogin.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = (loginEmail.value||"").trim();
      const pass  = (loginPass.value||"");
      btnDoLogin.disabled = true; btnDoLogin.style.opacity="0.7";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Login failed."), "bad");
      } finally{
        btnDoLogin.disabled = false; btnDoLogin.style.opacity="";
      }
    });

    formSignup.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = (signupEmail.value||"").trim();
      const pass  = (signupPass.value||"");
      btnDoSignup.disabled = true; btnDoSignup.style.opacity="0.7";
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await sendEmailVerification(cred.user);
        setMode("login", email);
      } catch(err){
        if (err?.code === "auth/email-already-in-use"){
          setMode("login", email);
          setStatus("Account already exists. Please login or reset your password.", "bad");
        } else {
          setStatus(friendly(err?.code) || (err?.message || "Signup failed."), "bad");
        }
      } finally{
        btnDoSignup.disabled = false; btnDoSignup.style.opacity="";
      }
    });

    btnBackId.addEventListener("click", ()=> setMode("identity"));

    btnForgot.addEventListener("click", async ()=> {
      const email = (loginEmail.value||"").trim();
      if (!email){ setStatus("Enter your email above, then click ‘Forgot password?’", "bad"); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        setStatus(`Password reset email sent to <span class="mono">${email}</span>.`, "ok");
      } catch(err){
        setStatus(friendly(err?.code) || (err?.message || "Could not send reset email."), "bad");
      }
    });

    btnResend.addEventListener("click", async ()=> {
      const u = auth.currentUser; if (!u) return;
      try{
        await sendEmailVerification(u);
        setStatus(`Verification email sent again to <span class="mono">${u.email}</span>.`, "ok");
      } catch(err){
        setStatus(`Could not resend verification email. ${err?.message||""}`, "bad");
      }
    });

    btnOut.addEventListener("click", async ()=> {
      await signOut(auth);
    });
  </script>
</body>
</html>